<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/head :: head">
<meta charset="utf-8" />

</head>

<body>
	<div class="page-wrapper chiller-theme toggled">
		<div th:replace="fragments/sb-admin :: mn-lat"></div>
		<!-- sidebar-wrapper  -->

		<div class="page-content">

			<div class="container-fluid">
				<div aria-live="polite" aria-atomic="true"
					style="min-height: 200px; position: fixed; z-index: 1000000000; right: 0px;">
					<div style="position: absolute; top: 0; right: 0;">
						<div id="toastMensajeError" class="toast" role="alert"
							style="width: 250px;" aria-live="assertive" aria-atomic="true"
							data-delay="40000">
							<div class="toast-header bg-danger">
								<strong class="mr-auto text-white">Error</strong>
								<!-- <small class="text-white">3 mins ago</small> -->
								<button type="button" class="ml-2 mb-1 close text-white"
									data-dismiss="toast" aria-label="Close">
									<span aria-hidden="true">×</span>
								</button>
							</div>
							<div class="toast-body" id="toastMensajeErrorBody">Hey,
								there! This is a Bootstrap 4 toast.</div>
						</div>
						<div id="toastMensajeCorrecto" class="toast" role="alert"
							style="width: 250px;" aria-live="assertive" aria-atomic="true"
							data-delay="40000">
							<div class="toast-header bg-success">
								<strong class="mr-auto text-white">Información</strong>
								<!-- <small class="text-white">3 mins ago</small> -->
								<button type="button" class="ml-2 mb-1 close text-white"
									data-dismiss="toast" aria-label="Close">
									<span aria-hidden="true">×</span>
								</button>
							</div>
							<div class="toast-body" id="toastMensajeCorrectoBody">Hey,
								there! This is a Bootstrap 4 toast.</div>
						</div>
					</div>
				</div>

				<div class="alert alert-primary" role="alert">
					<h3>Formato de Liquidación Anual y Dictamen</h3>
				</div>
				<div class="container-fluid">

					<div class="row">
						<div class="col-sm-2">
							<div class="form-group">
								<label>Año</label> <label class="form-control" id="anio">2019</label>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<div class="card">
								<div class="card-header bg-primary text-white">
									<p class="h6">Subir Dictamen</p>
								</div>
								<div class="card-body">
									<div class="row">
										<div class="col-sm-12">
											<div class="custom-file">
												<input type="file" class="custom-file-input"
													id="fdictamenupload" name="files"
													th:data-url="@{/Upload?subir=fdictamen&tipoDocumento=1}"
													multiple
													accept="application/pdf,application/vnd.ms-excel,application/vnd.ms-word"
													onchange="adjuntarArchivosDictamen(event)"> <label
													class="custom-file-label" for="fdictamenupload"
													data-browse="Seleccione">Seleccione archivo(s)
													hasta 30mb</label>
											</div>
										</div>
									</div>
									<div class="row mt-3">
										<div class="col-sm-12">
											<ul id="listaArchivosDictamen" class="list-unstyled">
											</ul>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-12" role="toolbar">
											<div class="btn-group" role="group" aria-label="First group">
												<button id="fdictamenuploadsubirtodo" type="button"
													class="btn btn-primary" onClick="subirTodoDictamen()">
													Subir Todo <i class="fa fa-upload"></i>
												</button>
											</div>
											<div class="btn-group" role="group" aria-label="First group">
												<button id="fdictamenuploadcancelatodo" type="button"
													class="btn btn-primary" onclick="cancelarTodoDictamen()">
													Cancelar Todo <i class="fa fa-trash "></i>
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-sm-6">
							<div class="card">
								<div class="card-header bg-primary text-white">
									<p class="h6">Subir Formato de Liquidación Anual</p>
								</div>
								<div class="card-body">
									<div class="row">
										<div class="col-sm-12">
											<div class="custom-file">
												<input type="file" class="custom-file-input"
													id="fFormatoupload" name="files2"
													th:data-url="@{/Upload?subir=fdictament&tipoDocumento=2}"
													accept="application/pdf,application/vnd.ms-excel,application/vnd.ms-word"
													onchange="adjuntarArchivosFormato(event)" multiple>
												<label class="custom-file-label" for="fFormatoupload"
													data-browse="Seleccione">Seleccione archivo(s)
													hasta 30mb</label>
											</div>
										</div>
									</div>
									<div class="row mt-3">
										<div class="col-sm-12">
											<ul id="listaArchivosFormato" class="list-unstyled">
											</ul>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-12 mt-2" role="toolbar">
											<div class="btn-group" role="group" aria-label="First group">
												<button type="button" class="btn btn-primary"
													id="fFormatouploadsubirtodo" onClick="subirTodoFormato()">
													Subir Todo <i class="fa fa-upload"></i>
												</button>
											</div>
											<div class="btn-group" role="group" aria-label="First group">
												<button type="button" class="btn btn-primary"
													id="fFormatouploadcancelatodo"
													onclick="cancelarTodoFormato()">
													Cancelar Todo <i class="fa fa-trash"></i>
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row mt-3">
						<div class="col-sm-12">
							<div class="btn-group" role="group" aria-label="First group">
								<button type="button" class="btn btn-primary"
									onclick="soloGuadar()">Sólo Guardar</button>
							</div>
							<div class="btn-group" role="group" aria-label="First group"
								id="btnGuardarEnviar">
								<button type="button" class="btn btn-primary"
									id="btnEnviarGuardar" onclick="guardarEnviar()">Guardar
									y Enviar</button>
							</div>
						</div>
					</div>
					<div class="row mt-3">
						<div class="col-sm-12">
							<div class="card">
								<div class="card-header bg-primary text-white">
									<p class="h6">Lista de Archivos Súbidosn</p>
								</div>
								<div class="card-body">
									<!--
									<div class="row">
										<div class="col-sm-4 form-group">
											<label>Período Tributario</label> <select class="form-control"
												id="exampleFormControlSelect1">
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
											</select>
										</div>
										<div class="col-sm-4 form-group">
											<label>Estado</label> <select class="form-control"
												id="exampleFormControlSelect1">
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
											</select>
										</div>
									</div>
									-->
									<div class="row">
										<div class="col-sm-12">
											<table class="table">
												<thead class="thead-dark">
													<tr>
														<th scope="col">AÑO</th>
														<th scope="col">FECHA DE REGISTRO</th>
														<th scope="col">ULTIMA FECHA MODIFICACIÓN</th>
														<th scope="col">ARCHIVO</th>
														<th scope="col">ESTADO</th>
													</tr>
												</thead>
												<tbody id="tblLiquidaciones">

												</tbody>
											</table>


										</div>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>






			</div>
		</div>

	</div>

	<!-- Footer -->


	<div th:replace="fragments/jsScripts :: scripts"></div>
	<script type="text/javascript">
		// jQuery(document)
		// 		.ready(
		// 			function($) {
		// 					var archivos = [ "pdf", "docx", "doc","xlsx","xls" ];
		// 					subir("fdictamen", archivos, 30);
		// 			}

		// 		);
		var context = [[@{/}]];
		var token = $("meta[name='_csrf']").attr("content");
		$('#fdictamenuploadsubirtodo').css("display", "none");
		$('#fdictamenuploadcancelatodo').css("display", "none");

		$('#fFormatouploadsubirtodo').css("display", "none");
		$('#fFormatouploadcancelatodo').css("display", "none");

		var archivosDictamen = [];
		var archivosFormato = [];
		var archivosDictamenResponse = [];
		var archivosFormatoResponse = [];
		// function adjuntarArchivosDictamen(event) {
		// 	//console.log(event);
		// 	archivosDictamen = [];
		// 	var archivos = event.target.files;
		// 	var archivosExtensionesPermitidos = ["pdf", "docx", "doc", "xlsx", "xls"];
		// 	var mayusArchivosExtensionesPermitidos = String.prototype.toUpperCase.apply(archivosExtensionesPermitidos).split(",");
		// 	var esValidoExtension = true;
		// 	var maxtamanio = 30;
		// 	var mensaje = "";
		// 	closeMensajes();
		// 	for (let index = 0; index < archivos.length; index++) {
		// 		var ext = archivos[index].name.substr(-3).toUpperCase();
		// 		// console.log("extension ",ext);
		// 		// console.log("extensiones ",mayusArchivosExtensionesPermitidos);
		// 		archivosDictamen.push(archivos[index]);
		// 		if (mayusArchivosExtensionesPermitidos.indexOf(ext) == -1) {
		// 			//uploadErrors.push('Solo se acepta archivos de formato ' + mayuscArracceptFileTypes);
		// 			mensaje = "Por favor seleccione archivos permitidos.";
		// 			esValidoExtension = false;
		// 			break;
		// 		}
		// 		if (archivos[index].size > ((parseInt(maxtamanio) + 1) * (1024 * 1024))) {
		// 			mensaje = 'El tama\u00f1o del archivo solo puede ser hasta ' + maxtamanio + ' mb.';
		// 			esValidoExtension = false;
		// 			break;
		// 		}
		// 		//const element = archivos[index];

		// 	}
		function guardarEnviar(){
			
			console.log("archivosFormato ",archivosFormato)
			console.log("archivosDictamen ",archivosDictamen)
			closeMensajes();
			if(archivosFormato.length>0 && archivosDictamen.length>0){				
				if (!registrarDictamen(2)) return;
				if(!registrarFormato(2))return;
				cancelarTodoDictamen();
				cancelarTodoFormato()
			}else{
				if(archivosDictamen.length==0){
				mensajeError('Por favor debe agregar archivo(s) dictamen.')
				return;					
				}
				if(archivosFormato.length==0){
				mensajeError('Por favor debe agregar archivo(s) formato de liquidación.')
				return;					
				}
			}
		}
		
		function soloGuadar(){
			registrarDictamen(1);
			registrarFormato(1);
		}
		function adjuntarArchivosDictamen(event) {
			//console.log(event);		
			archivosDictamen = [];
			var archivos = event.target.files;
			var archivosExtensionesPermitidos = ["pdf", "docx", "doc", "xlsx", "xls"];
			var mayusArchivosExtensionesPermitidos = String.prototype.toUpperCase.apply(archivosExtensionesPermitidos).split(",");
			var esValidoExtension = true;
			var maxtamanio = 30;
			var mensaje = "";
			closeMensajes();
			for (let index = 0; index < archivos.length; index++) {
				var ext = archivos[index].name.substr(-3).toUpperCase();
				// console.log("extension ",ext);
				// console.log("extensiones ",mayusArchivosExtensionesPermitidos);
				archivosDictamen.push(archivos[index]);
				if (mayusArchivosExtensionesPermitidos.indexOf(ext) == -1) {
					//uploadErrors.push('Solo se acepta archivos de formato ' + mayuscArracceptFileTypes);
					mensaje = "Por favor seleccione archivos permitidos.";
					esValidoExtension = false;
					break;
				}
				if (archivos[index].size > ((parseInt(maxtamanio) + 1) * (1024 * 1024))) {
					mensaje = 'El tama\u00f1o del archivo solo puede ser hasta ' + maxtamanio + ' mb.';
					esValidoExtension = false;
					break;
				}
				//const element = archivos[index];

			}
			//console.log("esvalido ",esValidoExtension);
			if (!esValidoExtension) {
				mensajeError(mensaje)
				//alert("ERROR")
				archivosDictamen = [];
				return;
			}


			cargarListaArchivoDictamen();
		

			$('#fdictamenuploadsubirtodo').css("display", "block");
			$('#fdictamenuploadcancelatodo').css("display", "block");
		}
		function cargarListaArchivoDictamen(){
			
			$('#listaArchivosDictamen').empty();
			archivosDictamen.forEach((archivo) => {
				var fileData = {
				  file: {
					  lastModified : archivo.lastModified,
					  lastModifiedDate: archivo.lastModifiedDate,
			          name:archivo.name,
			          size:archivo.size,
			          type:archivo.type
				  }
				}
				fileData = JSON.stringify(fileData.file);
				$('#listaArchivosDictamen').append("<li>" + 
						archivo.name + "   <button class='btn' onclick='retirarArchivo("+fileData+",1)'><i class='fa fa-trash text-danger'></i></button></li>")
			});
			if(archivosDictamen.length==0){

				$('#fdictamenuploadsubirtodo').css("display", "none");
				$('#fdictamenuploadcancelatodo').css("display", "none");
			}
			
		}
		function cargarListaArchivoFormato(){
			
			$('#listaArchivosFormato').empty();
			archivosFormato.forEach((archivo) => {
				var fileData = {
				  file: {
					  lastModified : archivo.lastModified,
					  lastModifiedDate: archivo.lastModifiedDate,
			          name:archivo.name,
			          size:archivo.size,
			          type:archivo.type
				  }
				}
				fileData = JSON.stringify(fileData.file);
				$('#listaArchivosFormato').append("<li>" + 
						archivo.name + "   <button class='btn' onclick='retirarArchivo("+fileData+",2)'><i class='fa fa-trash text-danger'></i></button></li>")
			});
			if(archivosFormato.length==0){

				$('#fFormatouploadsubirtodo').css("display", "none");
				$('#fFormatouploadcancelatodo').css("display", "none");
			}
			
		}
		function retirarArchivo(archivo,tipo){
			if(tipo==1){
				//console.log(archivo);
				//var archivoTmp = JSON.parse(archivo);
				archivosDictamen.splice(archivosDictamen.findIndex(v => v.name === archivo.name), 1);
				cargarListaArchivoDictamen();
				//console.log(archivosDictamen);
			}
			else if(tipo==2){
				archivosFormato.splice(archivosFormato.findIndex(v => v.name === archivo.name), 1);
				cargarListaArchivoFormato();
			}
				
		}
		function adjuntarArchivosFormato(event) {
			//console.log(event);
			archivosFormato = [];
			var archivos = event.target.files;
			var archivosExtensionesPermitidos = ["pdf", "docx", "doc", "xlsx", "xls"];
			var mayusArchivosExtensionesPermitidos = String.prototype.toUpperCase.apply(archivosExtensionesPermitidos).split(",");
			var esValidoExtension = true;
			var maxtamanio = 30;
			var mensaje = "";
			closeMensajes();
			for (let index = 0; index < archivos.length; index++) {
				var ext = archivos[index].name.substr(-3).toUpperCase();
				// console.log("extension ",ext);
				// console.log("extensiones ",mayusArchivosExtensionesPermitidos);
				
				if (mayusArchivosExtensionesPermitidos.indexOf(ext) == -1) {
					//uploadErrors.push('Solo se acepta archivos de formato ' + mayuscArracceptFileTypes);
					mensaje = "Por favor seleccione archivos permitidos.";
					esValidoExtension = false;
					break;
				}
				if (archivos[index].size > ((parseInt(maxtamanio) + 1) * (1024 * 1024))) {
					mensaje = 'El tama\u00f1o del archivo solo puede ser hasta ' + maxtamanio + ' mb.';
					esValidoExtension = false;
					break;
				}
				//const element = archivos[index];
				archivosFormato.push(archivos[index]);
			}
			//console.log("esvalido ",esValidoExtension);
			if (!esValidoExtension) {
				mensajeError(mensaje)
				//alert("ERROR")
				archivosFormato = [];
				return;
			}


			cargarListaArchivoFormato();
			/*
			archivosFormato.forEach((archivo) => {
				
				$('#listaArchivosFormato').append("<li>" + 
						archivo.name + "   <button class='btn' onclick='retirarArchivo("+fileData+",2)'><i class='fa fa-trash text-danger'></i></button></li>")
			})
			*/
			$('#fFormatouploadsubirtodo').css("display", "block");
			$('#fFormatouploadcancelatodo').css("display", "block");
		}
		function closeMensajes() {
			$('#toastMensajeError').toast('hide');
			$('#toastMensajeCorrecto').toast('hide');
		}
		function subirTodoDictamen() {


			//closeMensajes();
			$.each(archivosDictamen, function (index, param) {
				var formData = new FormData();
				formData.append("files", param);
				$.ajax({
					url: context + 'Upload?subir=fdictamen&tipoDocumento=1',
					type: "post",
					headers: {
						"X-CSRF-TOKEN": token
					},
					data: formData,
					cache: false,
					contentType: false,
					processData: false
				}).done(
					function (rest) {
						archivosDictamenResponse.push(rest);
					}
				)
			})
			mensajeCorrecto('Se subieron los archivos correctamente');			
			//cancelarTodoDictamen();
			limpiarControles('fdictamen');

		} 
		function subirTodoFormato() {
			
			
			
			$.each(archivosFormato, function (index, param) {
				var formData = new FormData();
				formData.append("files", param);
				$.ajax({
					url: context + 'Upload?subir=fFormato&tipoDocumento=2',
					type: "post",
					headers: {
						"X-CSRF-TOKEN": token
					},
					data: formData,
					cache: false,
					contentType: false,
					processData: false
				}).done(
					function (rest) {
						archivosFormatoResponse.push(rest);
					}
				)
			})
			//closeMensajes();
			mensajeCorrecto('Se subieron los archivos correctamente');
			//cancelarTodoFormato();
			limpiarControles('fFormato');

		}
		function mensajeCorrecto(mensaje) {
			$('#toastMensajeCorrectoBody').empty();
			$('#toastMensajeCorrectoBody').append('<p>' + mensaje + '</p>')
			$('#toastMensajeCorrecto').toast('show');
		}
		function mensajeError(mensaje) {
	    	
	
		
			$('#toastMensajeErrorBody').empty();
			$('#toastMensajeErrorBody').append('<p>' + mensaje + '</p>')
			$('#toastMensajeError').toast('show');
		}
		function cancelarTodoDictamen() {
			$('#fdictamenupload').val('');
			archivosDictamen = [];
			$('#listaArchivosDictamen').empty();
			$('#fdictamenuploadsubirtodo').css("display", "none");
			$('#fdictamenuploadcancelatodo').css("display", "none");
		}
		function limpiarControles(control) {
			$('#fFormatoupload').val('');
			$('#fdictamenupload').val('');
			//archivosFormato = [];
			//$('#listaArchivosFormato').empty();
			$('#'+control+ 'uploadsubirtodo').css("display", "none");
			$('#'+control+'uploadcancelatodo').css("display", "none");
		}
		function cancelarTodoFormato() {
			$('#fFormatoupload').val('');
			archivosFormato = [];
			$('#listaArchivosFormato').empty();
			$('#fFormatouploadsubirtodo').css("display", "none");
			$('#fFormatouploadcancelatodo').css("display", "none");
		}
		function registrarDictamen(estado) {
			var liquidaciones = [];
			var pAnio = $('#anio').text();
			closeMensajes();
			
			if(archivosDictamenResponse.length==0){
				mensajeError('Por favor selección el botón Subir Todo del Dictamen.');
				return false;
			}
			
			$.each(archivosDictamenResponse, function (index, archivoDictamen) {
				var data = {
					idPeriodo: 1,
					idTipoDocumento: 1,
					anio: pAnio,
					documento: archivoDictamen.fileName,
					estado: estado
				};
				liquidaciones.push(data);
				//console.log(archivoDictamen);


			});
			if (liquidaciones.length == 0) {
				return;
			}
			var url = context + 'api/liquidacion/registrar-liquidacion';
			$.ajax({
				headers: {
					"X-CSRF-TOKEN": token
				},
				// En data puedes utilizar un objeto JSON, un array o un query string
				data: JSON.stringify(liquidaciones),
				//Cambiar a type: POST si necesario
				type: "POST",
				// Formato de datos que se espera en la respuesta
				dataType: 'JSON',
				contentType: 'application/json',
				// URL a la que se enviará la solicitud Ajax
				url: url,
			})
				.done((rest) => {
					//console.log(rest);
					if (rest.resultado == 1) {
						mensajeCorrecto(rest.mensaje);
						cargarDatosLiquidaciones(rest.lista);
					}

				})
		}
		function registrarFormato(estado) {
			var liquidaciones = [];
			var pAnio = $('#anio').text();
			closeMensajes();
			if(archivosDictamenResponse.length==0){
				mensajeError('Por favor seleccione el botón Subir Todo del formato de liquidación.');
				return false;
			}
			$.each(archivosDictamenResponse, function (index, archivoFormato) {
				var data = {
					idPeriodo: 1,
					idTipoDocumento: 2,
					anio: pAnio,
					documento: archivoFormato.fileName,
					estado: estado
				};
				liquidaciones.push(data);
				//console.log(archivoDictamen);


			});
			if (liquidaciones.length == 0) {
				return;
			}
			var url = context + 'api/liquidacion/registrar-liquidacion';
			$.ajax({
				headers: {
					"X-CSRF-TOKEN": token
				},
				// En data puedes utilizar un objeto JSON, un array o un query string
				data: JSON.stringify(liquidaciones),
				//Cambiar a type: POST si necesario
				type: "POST",
				// Formato de datos que se espera en la respuesta
				dataType: 'JSON',
				contentType: 'application/json',
				// URL a la que se enviará la solicitud Ajax
				url: url,
			})
				.done((rest) => {
					//console.log(rest);
					if (rest.resultado == 1) {
						mensajeCorrecto(rest.mensaje);
						cargarDatosLiquidaciones(rest.lista);
					}

				})
		}
		function cargarDatosLiquidaciones(listaLiquidacion) {
			$('#tblLiquidaciones').empty();
			listaLiquidacion.forEach((liquidacion) => {
				//console.log(liquidacion);
				var fecha = new Date(liquidacion.fechaRegistro);
				var fechaModificacion = liquidacion.fechaModificacion == null ? '-' : new Date(liquidacion.fechaModificacion).toString('DD/MM/YYYY hh:mm:ss');
				var estado = liquidacion.estado==="1"?'SIN PRESENTAR':'PRESENTACIÓN NRO Y ENVIADO';
				var row = '<tr><td>' + liquidacion.anio + '</td>';
				row += '<td>' + moment(fecha).format('DD/MM/YYYY hh:mm:ss') + '</td>'
				row += '<td>' + fechaModificacion + '</td>'
				row += '<td>' + liquidacion.documento + '</td>'
				row += '<td>' + estado + '</td>'
				// row += '<td>' + liquidacion.fechaRegistro + '</td>'
				row += '</tr>'
				$('#tblLiquidaciones').append(row);
			})
		}
	</script>



</body>

</html>